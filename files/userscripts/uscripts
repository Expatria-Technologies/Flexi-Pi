#!/bin/bash

run_function0 (){
if [[ -f "board.txt" ]]; then
	sed -i 's/net.ifnames=0/net.ifnames=0 processor.max_cstate=1 isolcpus=2,3/g' board.txt
fi
}
run_function1 (){

# Copy debs to output
if [[ `ls p2/tmp/devel/*.deb` ]]; then
	cp -fr p2/tmp/devel/*.deb output/${BOARD}/
	rm -r /tmp/devel
fi
#remove sudo no password
rm -f /p2/etc/sudoers.d/010_${USERNAME}-nopasswd
echo "run_function 1 completed" 
}


run_function2 (){
echo "Starting run_function 2 - Install linuxcnc and xfce"	

#add isolcpus to config.txt
#sed -i "$ a processor.max_cstate=1\nisolcpus=2,3" p2/boot/broadcom/config.txt


# Intall xfce
apt install -y xfce4 xfce4-terminal xfce4-power-manager
apt install -y geany firefox-esr konsole

#install linuxcnc repositories
apt install -y dh-python libudev-dev docbook-xsl asciidoc ghostscript imagemagick asciidoc-dblatex bwidget intltool libboost-python-dev libepoxy-dev libgl1-mesa-dev libglu1-mesa-dev libgtk-3-dev libmodbus-dev libgpiod-dev libeditreadline-dev libusb-1.0-0-dev libxmu-dev netcat-traditional  netcat-openbsd po4a python3-dev python3-tk python3-xlib tcl8.6-dev tclx tk8.6-dev yapps2 libgtk2.0-dev

#Linuxcnc Docs - Commented out for the Pi to save space
#apt install -y dvipng fonts-dejavu graphviz groff inkscape python3-lxml source-highlight texlive-font-utils texlive-lang-cyrillic texlive-lang-european texlive-lang-french texlive-lang-german texlive-lang-polish texlive-lang-spanish w3c-linkchecker

# Clone and build Linuxcnc debs
mkdir -p /tmp/devel/
cd /tmp/devel/
git clone https://github.com/LinuxCNC/linuxcnc.git linuxcnc-dev
cd linuxcnc-dev/src
git checkout 2.9
cd ../debian
./configure no-docs
cd ..
dpkg-buildpackage -b -uc
cd ..

# Install the Linuxcnc Debs
apt install -y ./linuxcnc-uspace_2.9.0~pre1_arm64.deb
apt install -y ./linuxcnc-uspace-dev_2.9.0~pre1_arm64.deb

# Copy the debs to the users home folder
mkdir -p /home/cnc/linuxcnc-debs
cp *.deb /home/cnc/linuxcnc-debs
cd ..

# Remove the build folders. Tmp folder gets overridden anyway)
#rm -r devel

# Finished!
echo "All done installing linuxcnc!"
}
