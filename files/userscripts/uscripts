#!/bin/bash

run_function0 (){

if [[ -f "board.txt" ]]; then
	sed -i 's/net.ifnames=0/net.ifnames=0 processor.max_cstate=1 isolcpus=2,3/g' board.txt
fi
}
run_function1 (){

# move sudo no password
rm -f /p2/etc/sudoers.d/010_${USERNAME}-nopasswd
echo "run_function 1 completed" 
}

run_function2 (){

# Get the Linuxcnc Debs
    echo "downloading linuxcnc debs" 
	mkdir -p /tmp/linuxcnc/
	cd /tmp/linuxcnc/
    wget https://www.linuxcnc.org/dists/bookworm/2.9-uspace/binary-arm64/linuxcnc-doc-de_2.9.1_all.deb
    wget https://www.linuxcnc.org/dists/bookworm/2.9-uspace/binary-arm64/linuxcnc-doc-en_2.9.1_all.deb
    wget https://www.linuxcnc.org/dists/bookworm/2.9-uspace/binary-arm64/linuxcnc-doc-es_2.9.1_all.deb
    wget https://www.linuxcnc.org/dists/bookworm/2.9-uspace/binary-arm64/linuxcnc-doc-fr_2.9.1_all.deb
    wget https://www.linuxcnc.org/dists/bookworm/2.9-uspace/binary-arm64/linuxcnc-doc-zh-cn_2.9.1_all.deb
    wget https://www.linuxcnc.org/dists/bookworm/2.9-uspace/binary-arm64/linuxcnc-uspace-dbgsym_2.9.1_arm64.deb
    wget https://www.linuxcnc.org/dists/bookworm/2.9-uspace/binary-arm64/linuxcnc-uspace-dev_2.9.1_arm64.deb
    wget https://www.linuxcnc.org/dists/bookworm/2.9-uspace/binary-arm64/linuxcnc-uspace_2.9.1_arm64.deb

echo "installing linuxcnc debs" 
FILES="/tmp/linuxcnc/*.deb" 
for f in $FILES                        # We need to install debs in the right order and we don't want debug symbols
do
  if [[  $f == *dbgsym*.deb ]] 
  then
    continue      # Skip installing this deb file
  fi
  if [[  $f == *dev*.deb ]] 
  then
    g=$f               # save linuxcnc-uspace-dev file name and install it last
    continue      
  fi   
  echo "Installing $f" # linuxcnc-uspace
  dpkg -i "$f"          #dpkg will fail if dependencies are not installed 
done
echo "Installing $g"   # linuxcnc-uspace-dev
dpkg -i "$g"

# Finished!
echo "Stage 2 All done installing linuxcnc!"
cd /tmp/
rm -rf /tmp/linuxcnc 
}

run_function3 (){
echo "Entering run_function3 - nothing to do"	

}
