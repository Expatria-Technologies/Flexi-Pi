# Stage1

# rootfs
extract_rootfs(){
if [ -e ${DISTRO}-${DISTRO_VERSION}-${ROOTFS_ARCH}.tar.xz ]; then
	echo ""
	echo -n "Extracting rootfs "
	tar -xf ${DISTRO}-${DISTRO_VERSION}-${ROOTFS_ARCH}.tar.xz -C p2/
	echo_bdone;
else
	echo ""
	echo -e "${YLW}Missing rootfs tarball${FIN}!"
	make cleanup
	exit;
fi
echo ""
}

stage1_kernel(){
if [[ `ls ${OUTPUT}/{raspberrypi-linux-image_*.deb,raspberrypi-linux-headers_*.deb}` ]] > /dev/null 2>&1; then
		cp ${OUTPUT}/*.deb p2/root;
fi
}

# Stage 2
# USER CONFIG
user_config(){
echo -n "${BOARD}" > /etc/hostname
sed -i "1 a 127.0.1.1	${BOARD}" /etc/hosts
adduser ${user} --gecos ${user^} --disabled-password

echo "${user}:${passwd}" | chpasswd
adduser ${user} sudo
adduser ${user} audio
adduser ${user} dialout
adduser ${user} video
adduser ${user} disk
adduser ${user} plugdev
adduser ${user} netdev
adduser ${user} bluetooth
adduser ${user} input
adduser ${user} tty
if [[ `grep -w "spi" "/etc/group"` ]]; then
	adduser ${user} spi;
else
	groupadd spi;
	adduser ${user} spi;
fi
if [[ `grep -w "i2c" "/etc/group"` ]]; then
	adduser ${user} i2c;
else
	groupadd i2c;
	adduser ${user} i2c;
fi
if [[ `grep -w "gpio" "/etc/group"` ]]; then
	adduser ${user} gpio;
else
	groupadd gpio;
	adduser ${user} gpio;
fi
if [[ "$DISTRO" == "devuan" ]]; then
	if [[ `grep -w "kvm" "/etc/group"` ]]; then
		:;
	else
		addgroup --gid 125 kvm;
	fi
fi

mkdir -p /usr/share/mc/skins
mv -f darkgreen.ini /usr/share/mc/skins/darkgreen.ini
mv -f darkred.ini /usr/share/mc/skins/darkred.ini
mkdir -p /root/.config/mc
mv -f root-ini /root/.config/mc/ini
mv -f nanorc-root /root/.nanorc
mkdir -p /home/${user}/.config/mc
mv -f user-ini /home/${user}/.config/mc/ini
mv -f nanorc-user /home/${user}/.nanorc
chown -R root:root /root
chown -R ${user}:${user} /home/${user}
rm -f /etc/sudoers.d/010_pi-nopasswd
tee /etc/sudoers.d/010_${user}-nopasswd <<EOF
${user} ALL=(ALL) NOPASSWD: ALL
EOF
rm -f username.txt
rm -f whogoesthere
chown -R ${user}:${user} /home/${user}
}

# ADMIN CONFIG
admin_config(){
echo -n "${BOARD}" > /etc/hostname
sed -i "1 a 127.0.1.1	${BOARD}" /etc/hosts

if [[ `grep -w "spi" "/etc/group"` ]]; then
	:;
else
	groupadd spi;
fi
if [[ `grep -w "i2c" "/etc/group"` ]]; then
	:;
else
	groupadd i2c;
fi
if [[ `grep -w "gpio" "/etc/group"` ]]; then
	:;
else
	groupadd gpio;
fi
if [[ "DISTRO" = "devuan" ]]; then
	if [[ `grep -w "kvm" "/etc/group"` ]]; then
		:;
	else
		addgroup --gid 125 kvm;
	fi
fi

mkdir -p /usr/share/mc/skins
mv -f darkgreen.ini /usr/share/mc/skins/darkgreen.ini
mv -f darkred.ini /usr/share/mc/skins/darkred.ini
mkdir -p /root/.config/mc
mv -f root-ini /root/.config/mc/ini
mv -f nanorc-root /root/.nanorc
mv -f user-ini /etc/opt/user-ini
mv -f nanorc-user /etc/opt/nanorc-user
chown -R root:root /root
mv -f username.txt /boot/
mv -f whogoesthere /usr/local/bin/
chmod +x /usr/local/bin/whogoesthere
chown -R root:root /usr/local/bin/whogoesthere
}

root_password(){
echo "root:toor" | chpasswd
}

wireless_regdb(){
echo ""
echo "Adding regdb ..."
if [[ "$DISTRO" == "ubuntu" ]]; then
	echo 'KERNEL=="regulatory*", ACTION=="change", SUBSYSTEM=="platform", RUN+="/sbin/crda"' > /etc/udev/rules.d/60-regdb.rules;
fi
git clone https://kernel.googlesource.com/pub/scm/linux/kernel/git/sforshee/wireless-regdb
cd wireless-regdb
cp -f regulatory.db /lib/firmware/regulatory.db
cp -f regulatory.db.p7s /lib/firmware/regulatory.db.p7s
cd ~
rm -fdr wireless-regdb
echo "Done."
}

# SYS-MODS
raspberrypi_sys_mods(){
echo ""
echo "Installing raspi-sys-mods ..."
apt update
apt install -y debhelper d-shlibs rfkill dosfstools psmisc
git clone https://github.com/RPi-Distro/raspberrypi-sys-mods.git
if [[ `grep -w 'DISTRO="devuan"' "/root/userdata.txt"` ]]; then
	mv -f raspberrypi-sys-mods-control.patch raspberrypi-sys-mods/
	cd raspberrypi-sys-mods
	patch -p1 < raspberrypi-sys-mods-control.patch
	rm -f raspberrypi-sys-mods-control.patch;
else
	cd raspberrypi-sys-mods;
fi
dpkg-buildpackage -us -uc
cd ~
dpkg -i raspberrypi-sys-mods*.deb
rm -fdR raspberrypi-sys-mods*
if [ -e /etc/apt/sources.list.d/vscode.list ]; then
	rm -f /etc/apt/sources.list.d/vscode.list;
fi
if [ -e /etc/apt/trusted.gpg.d/microsoft.gpg ]; then
	rm -f /etc/apt/trusted.gpg.d/microsoft.gpg;
fi
if [ -e /etc/apt/preferences.d/3rd_parties.pref ]; then
	rm -f /etc/apt/preferences.d/3rd_parties.pref;
fi
echo "Done."
}

# EEPROM
find_eeprom(){
EEPROM_VERSION=$(curl --silent -L ${CHANGELOG} | awk '{if (NR==1) {print substr($2, 1, length($2)-3)}}' | sed 's/[()]//g')
if [[ `wget -S --spider ${ERURL}rpi-eeprom_${EEPROM_VERSION}.orig.tar.gz 2>&1 | grep 'HTTP/1.1 200 OK'` ]]; then
	download_eeprom;
else
	finding_eeprom;
fi
}

finding_eeprom(){
EEPROM_VERSION=$(curl --silent -L ${CHANGELOG} | awk '{if (NR==10) {print substr($2, 1, length($2)-3)}}' | sed 's/[()]//g')
if [[ `wget -S --spider ${ERURL}rpi-eeprom_${EEPROM_VERSION}.orig.tar.gz 2>&1 | grep 'HTTP/1.1 200 OK'` ]]; then
	download_eeprom;
else
	EEPROM_VERSION="13.3"
	download_eeprom;
fi
}

download_eeprom(){
wget -cq --show-progress ${ERURL}rpi-eeprom_${EEPROM_VERSION}-1.debian.tar.xz
wget -cq --show-progress ${ERURL}rpi-eeprom_${EEPROM_VERSION}.orig.tar.gz
}

bcm2711_eeprom(){
ERURL="https://archive.raspberrypi.org/debian/pool/main/r/rpi-eeprom/"
CHANGELOG="https://raw.githubusercontent.com/raspberrypi/rpi-eeprom/debian/bullseye/debian/changelog"
echo ""
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
echo "Installing rpi-eeprom ..."
apt install help2man rsync pciutils -y
mkdir -p ~/eeprom
mv -f rpi-eeprom-update.patch /root/eeprom/
mv -f rpi-eeprom-control.patch /root/eeprom/
cd ~/eeprom
find_eeprom
tar xf rpi-eeprom_${EEPROM_VERSION}.orig.tar.gz
tar xf rpi-eeprom_${EEPROM_VERSION}-1.debian.tar.xz
rm -f rpi-eeprom_${EEPROM_VERSION}-1.debian.tar.xz
mkdir -p debian/patches
mv rpi-eeprom-update.patch debian/patches/rpi-eeprom-update.patch 
echo rpi-eeprom-update.patch >> debian/patches/series
mv -f debian rpi-eeprom-${EEPROM_VERSION}/
mv rpi-eeprom-control.patch rpi-eeprom-${EEPROM_VERSION}/
cd rpi-eeprom-${EEPROM_VERSION}
patch -p1 < rpi-eeprom-control.patch
rm -f rpi-eeprom-control.patch
dpkg-buildpackage -us -nc -uc
cd ..
dpkg -i *.deb
cd ..
rm -fdr eeprom
echo "Done."
}

# Userland
rpi_userland(){
echo ""
echo "Installing userland ..."
rm -f /etc/profile
mv -f profile /etc/profile
mv rpi-vc.conf /etc/ld.so.conf.d/rpi-vc.conf
chown root:root /etc/profile
chown root:root /etc/ld.so.conf.d/rpi-vc.conf
mkdir -p /opt
git clone https://github.com/raspberrypi/userland.git
mv -f userland-remove-hi-pi.patch /root/userland/
cd userland
patch -p1 < userland-remove-hi-pi.patch
rm -f userland-remove-hi-pi.patch
if [[ "$ARCH" == "arm64" ]]; then
	echo -e "\e[1;37m== ARM64\e[0m"
	sleep 1s
	./buildme --aarch64;
else
	echo -e "\e[1;37m== ARM\e[0m"
	sleep 1s
	./buildme;
fi
cd ~
rm -fdr userland
ldconfig
echo "Done."
}

# Modules
bcm_modules(){
rm -f /etc/modules
tee /etc/modules <<EOF
# /etc/modules: kernel modules to load at boot time.
#
# This file contains the names of kernel modules that should be loaded
# at boot time, one per line. Lines beginning with "#" are ignored.
#bcm2835-v4l2
#i2c-dev

EOF
chown root:root /etc/modules
}

bcm2710_modules(){
rm -f /etc/modules
tee /etc/modules <<EOF
# /etc/modules: kernel modules to load at boot time.
#
# This file contains the names of kernel modules that should be loaded
# at boot time, one per line. Lines beginning with "#" are ignored.
#bcm2835-v4l2
#i2c-dev
snd_bcm2835

EOF
chown root:root /etc/modules
}

# Zramswap setup
zramswap_config(){
sed -i 's/#ALLOCATION=256/ALLOCATION=1024/g' /etc/default/zramswap
sed -i 's/#SIZE=256/SIZE=1024/g' /etc/default/zramswap
sed -i 's/#PRIORITY=100/PRIORITY=100/g' /etc/default/zramswap
}

# Flush runtime journal
systemd_journald(){
# system.journal corrupted or uncleanly shut down, renaming and replacing
if [ -e /etc/systemd/journald.conf ]; then
	sed -i 's/#Storage=auto/Storage=volatile/g' /etc/systemd/journald.conf;
	sed -i 's/#SystemMaxFileSize=/SystemMaxFileSize=50M/g' /etc/systemd/journald.conf;
	sed -i 's/#SystemMaxFiles=100/SystemMaxFiles=5/g' /etc/systemd/journald.conf;
fi
}

# Download kernel archive
download_kernel(){
DOWNLOAD="aria2c -c --download-result=hide --console-log-level=error --disable-ipv6=true --summary-interval=0 --show-files=false"
KURL="https://github.com/pyavitz/rpi-linux/releases/download/gcc-10/"
echo -e -n "\e[1;37mSearching\e[0m ...";
sleep 1s;
if [[ "$BOARD" == "bcm2711" ]]; then
	if [[ "$ARCH" == "arm64" ]]; then
		if [[ `wget -S --spider ${KURL}rpi4-${VERSION}.tar.xz 2>&1 | grep 'HTTP/1.1 200 OK'` ]]; then
			${DOWNLOAD} ${KURL}rpi4-${VERSION}.tar.xz;
			echo "";
			tar xf rpi4-${VERSION}.tar.xz;
			cd rpi4-${VERSION};
			dpkg -i *.deb;
			cd ~;
			rm -fdr rpi4-${VERSION}*;
		else
			${DOWNLOAD} ${KURL}rpi4-5.15.y.tar.xz
			echo "";
			tar xf rpi4-5.15.y.tar.xz;
			cd rpi4-5.15.y;
			dpkg -i *.deb;
			cd ~;
			rm -fdr rpi4-5.15.y*;
		fi
	fi
fi
if [[ "$BOARD" == "bcm2711" ]]; then
	if [[ "$ARCH" == "arm" ]]; then
		if [[ `wget -S --spider ${KURL}rpi4v7-${VERSION}.tar.xz 2>&1 | grep 'HTTP/1.1 200 OK'` ]]; then
			${DOWNLOAD} ${KURL}rpi4v7-${VERSION}.tar.xz;
			echo "";
			tar xf rpi4v7-${VERSION}.tar.xz;
			cd rpi4v7-${VERSION};
			dpkg -i *.deb;
			cd ~;
			rm -fdr rpi4v7-${VERSION}*;
		else
			${DOWNLOAD} ${KURL}rpi4v7-5.15.y.tar.xz
			echo "";
			tar xf rpi4v7-5.15.y.tar.xz;
			cd rpi4v7-5.15.y;
			dpkg -i *.deb;
			cd ~;
			rm -fdr rpi4v7-5.15.y*;
		fi
	fi
fi
if [[ "$BOARD" == "bcm2710" ]]; then
	if [[ `wget -S --spider ${KURL}rpi3-${VERSION}.tar.xz 2>&1 | grep 'HTTP/1.1 200 OK'` ]]; then
		${DOWNLOAD} ${KURL}rpi3-${VERSION}.tar.xz;
		echo "";
		tar xf rpi3-${VERSION}.tar.xz;
		cd rpi3-${VERSION};
		dpkg -i *.deb;
		cd ~;
		rm -fdr rpi3-${VERSION}*;
	else
		${DOWNLOAD} ${KURL}rpi3-5.15.y.tar.xz
		echo "";
		tar xf rpi3-5.15.y.tar.xz;
		cd rpi3-5.15.y;
		dpkg -i *.deb;
		cd ~;
		rm -fdr rpi3-5.15.y*;
	fi
fi
if [[ "$BOARD" == "bcm2709" ]]; then
	if [[ `wget -S --spider ${KURL}rpi2-${VERSION}.tar.xz 2>&1 | grep 'HTTP/1.1 200 OK'` ]]; then
		${DOWNLOAD} ${KURL}rpi2-${VERSION}.tar.xz;
		echo "";
		tar xf rpi2-${VERSION}.tar.xz;
		cd rpi2-${VERSION};
		dpkg -i *.deb;
		cd ~;
		rm -fdr rpi2-${VERSION}*;
	else
		${DOWNLOAD} ${KURL}rpi2-5.15.y.tar.xz
		echo "";
		tar xf rpi2-5.15.y.tar.xz;
		cd rpi2-5.15.y;
		dpkg -i *.deb;
		cd ~;
		rm -fdr rpi2-5.15.y*;
	fi
fi
if [[ "$BOARD" == "bcm2708" ]]; then
	if [[ `wget -S --spider ${KURL}rpi-${VERSION}.tar.xz 2>&1 | grep 'HTTP/1.1 200 OK'` ]]; then
		${DOWNLOAD} ${KURL}rpi-${VERSION}.tar.xz;
		echo "";
		tar xf rpi-${VERSION}.tar.xz;
		cd rpi-${VERSION};
		dpkg -i *.deb;
		cd ~;
		rm -fdr rpi-${VERSION}*;
	else
		${DOWNLOAD} ${KURL}rpi-5.15.y.tar.xz
		echo "";
		tar xf rpi-5.15.y.tar.xz;
		cd rpi-5.15.y;
		dpkg -i *.deb;
		cd ~;
		rm -fdr rpi-5.15.y*;
	fi
fi
}

# Kernel
stage2_kernel(){
echo ""
echo "Installing kernel ..."
apt update
apt upgrade -y
apt -y clean
apt -y autoclean
sleep 1s
cd ~
if [[ `ls /root/{raspberrypi-linux-image_*.deb,raspberrypi-linux-headers_*.deb}` ]] > /dev/null 2>&1; then
	dpkg -i *.deb;
	rm -f *.deb;
else
	download_kernel;
fi
echo "Done."
sleep 1s
fetch_version
}

# Fetch kernel version
fetch_version(){
echo 'INSTALLED_KERNEL="' > /root/kernel1
cat /usr/src/linux-headers*/include/config/kernel.release > /root/kernel2
echo '"' > /root/kernel3
paste -d '\0' kernel1 kernel2 kernel3  > /root/kernel.txt
rm -f kernel1 kernel2 kernel3
if [ $ext4 -eq 1 ]; then
	echo FSTYPE='"'ext4'"' >> /root/kernel.txt;
fi
if [ $btrfs -eq 1 ]; then
	echo FSTYPE='"'btrfs'"' >> /root/kernel.txt;
fi
if [ $xfs -eq 1 ]; then
	echo FSTYPE='"'xfs'"' >> /root/kernel.txt;
fi
}

# User scripts
uscripts_stage1(){
mkdir -p p2/root/userscripts
cp -f files/userscripts/* p2/root/userscripts/
rm -f p2/root/userscripts/README.md
}

uscripts_stage2(){
echo
echo -e "\e[1;33mAdding user scripts\e[0m."
mkdir -p /usr/local/bin
cp -f userscripts/* /usr/local/bin/
rm -fdr userscripts 
chmod +x /usr/local/bin/*
sleep 1s
echo -e "\e[1;33mDone\e[0m."
echo
}

# Firmware
extra_firmware(){
echo ""
echo "Adding firmware ..."
mkdir -p /lib/firmware/brcm
mkdir -p /lib/firmware/updates
git clone https://github.com/pyavitz/firmware.git /lib/firmware/updates/brcm
mv fw-0a5c_21e8.hcd /lib/firmware/brcm/BCM20702A0-0a5c-21e8.hcd
cp /lib/firmware/brcm/BCM20702A0-0a5c-21e8.hcd /lib/firmware/brcm/BCM20702A1-0a5c-21e8.hcd
chown root:root /lib/firmware/brcm/BCM20702A1-0a5c-21e8.hcd
chown root:root /lib/firmware/brcm/BCM20702A0-0a5c-21e8.hcd
install -Dm644 UPDATE.mem /lib/firmware/updates/renesas_usb_fw.mem
rm -f UPDATE.mem
ln -sr /lib/firmware /etc/firmware
mkdir -p /lib/firmware/updates/rtl_nic
cd /lib/firmware/updates/rtl_nic
wget -cq https://kernel.googlesource.com/pub/scm/linux/kernel/git/firmware/linux-firmware.git/+archive/refs/heads/main/rtl_nic.tar.gz
if [ -e rtl_nic.tar.gz ]; then
	tar xf rtl_nic.tar.gz
	rm -f rtl_nic.tar.gz;
else
	:;
fi
cd ~
echo "Done."
}

# Initrd script
initrd_script(){
cd ~
if [ -e /root/99-initrd ]; then
	mkdir -p /etc/initramfs/post-update.d/
	mv -f 99-initrd /etc/initramfs/post-update.d/
	chmod +x /etc/initramfs/post-update.d/99-initrd
	chown root:root /etc/initramfs/post-update.d/99-initrd
fi
}

### Finish
# Defrag
defrag_p2(){
if [ $ext4 -eq 1 ]; then
	e4defrag -c p2;
else
	if [ $btrfs -eq 1 ]; then
		btrfs filesystem defragment -f -r p2;
	else
		if [ $xfs -eq 1 ]; then
			xfs_fsr p2;
		fi
	fi
fi
}

# Shrink
ext4_shrink(){
echo ""
chmod +x scripts/shrink
scripts/shrink -s ${BOARD_EXT}-${DISTRO}-${DISTRO_VERSION}-${IMAGE_DATE}.img
echo 'LOOP1="/dev/mapper/' > kpart1
echo 'LOOP2="/dev/mapper/' >> kpart1
IMAGE_FILE="${BOARD_EXT}-${DISTRO}-${DISTRO_VERSION}-${IMAGE_DATE}.img"
kpartx="$(kpartx -av $IMAGE_FILE)"
echo "$kpartx"
if [[ `grep -w "VERSION_CODENAME=jammy" "/etc/os-release"` ]]; then
	# snapd woes; grep for higher loop numbers
	grep -o 'loop[0-9]\+p.' <<<"$kpartx" > kpart2;
else
	grep -o 'loop.p.' <<<"$kpartx" > kpart2;
fi
echo '"' > kpart3
echo '"' >> kpart3
paste -d '\0' kpart1 kpart2 kpart3 > kpart.txt
rm -f {kpart1,kpart2,kpart3}
source kpart.txt
BOOT="${LOOP1}"
mkdir -p p1
sleep 1s
mount "${BOOT}" p1
rm -f p1/cmdline.txt
rm -f part-uuid.txt
ROOTFS="${LOOP2}"
ROOT_PARTUUID=$(blkid -o export -- ${ROOTFS} | sed -ne 's/^PARTUUID=//p')
echo ROOT_PARTUUID='"'$ROOT_PARTUUID'"' > part-uuid.txt
source part-uuid.txt
cmdline
sleep 1s
umount p1
rm -fdr p1
kpartx -d ${IMAGE_FILE}
rm -f kpart.txt
}

# Rename and compress
rename_image(){
source kernel.txt
mv -f ${BOARD_EXT}-${DISTRO}-${DISTRO_VERSION}-${IMAGE_DATE}.img ${BOARD_EXT}-${DISTRO}-${DISTRO_VERSION}-${INSTALLED_KERNEL}-${FSTYPE}-${IMAGE_DATE}.img
}

compress_image(){
source kernel.txt
mv -f ${BOARD_EXT}-${DISTRO}-${DISTRO_VERSION}-${IMAGE_DATE}.img ${BOARD_EXT}-${DISTRO}-${DISTRO_VERSION}-${INSTALLED_KERNEL}-${FSTYPE}-${IMAGE_DATE}.img
xz -zev --threads=${CORES} ${BOARD_EXT}-${DISTRO}-${DISTRO_VERSION}-${INSTALLED_KERNEL}-${FSTYPE}-${IMAGE_DATE}.img
}

# LED script
led_script(){
tee /usr/local/sbin/leds <<EOF
#!/bin/bash

if [[ -e /dev/mmcblk0 ]]; then 
	if [ -e /sys/class/leds/led0/trigger ]; then
		echo "mmc0" | tee /sys/class/leds/led0/trigger;
	fi
fi

if [[ -e /dev/mmcblk1 ]]; then 
	if [ -e /sys/class/leds/ACT/trigger ]; then
		echo "mmc1" | tee /sys/class/leds/ACT/trigger;
	fi
fi

pwr_default(){
sh -c 'echo 0 > /sys/class/leds/led1/brightness'
}

pwr_mainline(){
sh -c 'echo 0 > /sys/class/leds/PWR/brightness'
}

if [ -e /sys/class/leds/led1/brightness ]; then
	pwr_default;
fi
if [ -e /sys/class/leds/PWR/brightness ]; then
	pwr_mainline;
fi
EOF
chmod +x /usr/local/sbin/leds
chown -R root:root /usr/local/sbin/leds
}
